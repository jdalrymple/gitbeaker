language: node_js

notifications:
  email: false
  
cache: npm

node_js:
  - 10.15.3
  - 8.9.0

before_script:
    ## Spin up container
  - cd test/docker/
  - docker-compose -f docker-compose.test.yml up -d

script:
  - npm run lint
  - npm run build
  - npm run test:unit
  - sleep 15
  - export PERSONAL_ACCESS_TOKEN=$(docker exec -it gitlab bash -lc 'printf "%q" "${PERSONAL_ACCESS_TOKEN}"')
  - export GITLAB_URL=$(docker exec -it gitlab bash -lc 'printf "%q" "${GITLAB_URL}"')
  - echo $GITLAB_URL
  - echo $PERSONAL_ACCESS_TOKEN
  - npm run test:integration

deploy:
  - provider: script
    skip_cleanup: true
    script: npm run release
    on:
      node_js: 10.15.3
